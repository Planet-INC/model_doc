\subsection{The equation}

Let's consider an equation to solve:
\begin{equation}
\begin{split}
& \ddoverd{u}{x} = 0,\qquad x \in [0,1] \\
& u(0) = 0, \; u(1) = 0
\end{split}
\label{sec:math:eq}
\end{equation}
This is a simple equation to solve.
We multiply by a function $v$ from a space $\mathcal{V}$
(see~\ref{sec:math:ipp} for integration by parts):
\begin{equation}
\begin{split}
            & \ddoverd{u}{x} = 0 \\
\Rightarrow & \ddoverd{u}{x} v = 0 \\
\Rightarrow & \int_0^1\ddoverd{u}{x} v \dd x = 0 \\
\Rightarrow & -\int_0^1\doverd{u}{x}\doverd{v}{x} \dd x + \left[\doverd{u}{x}v\right]_0^1 = 0 \qquad \forall v \in \mathcal{H}^1\\
\end{split}
\end{equation}
$\mathcal{H}^1$ is the ensemble of functions with at least one square-integrable
first derivative.
There is a choice in the $v$ function, and in this case, as we know the solutions
at the boundary conditions, we can get rid of them with a function $v$ such as
$v(0) = v(1) = 0$. We obtain thus
\begin{equation}
\int_0^1\doverd{u}{x}\doverd{v}{x} \dd x = 0, \qquad \forall v \in \mathcal{H}_0^1
\label{sec:math:weak_form}
\end{equation}
with $\mathcal{H}_0^1$ the ensemble of the functions having a finite countable numbers
of differentiable points and null at the points $0$ and $1$.

Now we need to discretize it. We consider a mesh of $N$ points between $0$ and $1$, we
express then:
\begin{equation}
\begin{split}
& u(x) = \sum_{i=1}^{N} \ui_i \phi_i \\
& v(x) = \sum_{i=1}^{N} \vi_i \phi_i
\end{split}
\label{sec:math:discretization}
\end{equation}
with $\{\phi\}$ the basis functions.

\subsection{Description of \texorpdfstring{$\phi$}{the basis functions}}

We need any function differentiable in any countable number of points such as
it is null at $0$ and $1$. A nice
choice is a hat function:
\begin{equation}
\left\{\begin{array}{l@{,\qquad}r}
\phi_i(x) = \frac{1}{x_i - x_{i-1}} - \frac{x_{i-1}}{x_i - x_{i-1}} & x \in [x_{i-1},x_i] \\
\phi_i(x) = \frac{1}{x_i - x_{i+1}} - \frac{x_{i+1}}{x_i - x_{i+1}} & x \in ]x_i,x_{i+1}] \\
\phi_i(x) = 0                                                       & \text{otherwise}
\end{array}\right.
\end{equation}
\begin{figure}
\centering
\includegraphics{hat_function}
\caption{\label{sec:math:hat_function}A hat function: here is $\phi_i$.}
\end{figure}

\subsection{Discretization and solving}

Using the set of basis functions (Eq.~\ref{sec:math:discretization}), we rewrite 
Eq.~\ref{sec:math:weak_form}.
\begin{equation}
\begin{split}
\int_0^1\sum_{i=1}^N\ui_i\doverd{\phi_i}{x}\sum_{j=1}^N\vi_j\doverd{\phi_j}{x} \dd x & = 0 \\
\sum_{i=1}^N\sum_{j=1}^N\ui_i\vi_j\int_0^1\doverd{\phi_i}{x}\doverd{\phi_j}{x} \dd x & = 0 \\
\end{split}
\label{sec:math:weak_discrete}
\end{equation}
Now if you look at the functions $\phi$, you'll see that the integrals are null except
around the considered node:
\begin{equation}
\int_0^1\doverd{\phi_i}{x} \dd x = \int_{x_{i-1}}^{x_{i+1}}\doverd{\phi_i}{x} \dd x
\end{equation}
So basically, you can define a nice matrix:
\begin{equation}
\matrice{K},\; K_{ij} = \int_{x_{i-1}}^{x_{i+1}}\doverd{\phi_i}{x}\doverd{\phi_j}{x} \dd x
\end{equation}
and using the $v$ function such as $\forall i \in [1,N], \; \vi_i = 1$, noting
\matrice{u} the $\ui_i$ column vector, we can
rewrite~\ref{sec:math:weak_discrete}:
\begin{equation}
\matrice{K} \matrice{u} = \matrice{b}
\end{equation}
with $\matrice{b} = 0$. So now it all comes down to a linear solve, and that's what
\LibMesh\ does nicely. \GRINS\ provides the formulation.

\subsection{Some definitions}
To better cope with \GRINS\ and \LibMesh, let's give some definitions here:
\\\\
\begin{tabular}{ll}\toprule
$\doverd{\phi_i}{x}\doverd{\phi_j}{x}$ & \matrice{K}, stiffness matrix\\
$\phi_i\phi_j$                         & mass term\\
\bottomrule
\end{tabular}

%%%% local defs
\newcommand{\intvol}  {\ensuremath{\int_{\text{atm}}}}
\newcommand{\intr}    {\ensuremath{\int_{\varphi_0}^{\varphi_1}\int_{\theta_0}^{\theta_1}\int_{r_0}^{r_1}}}
\newcommand{\inttheta}{\ensuremath{\int_{\theta_0}^{\theta_1}}}
\newcommand{\intphy}  {\ensuremath{\int_{\varphi_0}^{\varphi_1}}}
\newcommand{\dVs}     {\ensuremath{r^2\sin(\theta)\dd\theta\dd\varphi\dd r}}

\subsection{Photochemical equation}
\label{math:photo_solve}
The photochemical equation, Eq.~\ref{Titan:photochem_eq}, can be written as:
\begin{equation}
\doverd{u}{t} - \chi - \doverd{(u\omega)}{r} - \frac{2}{r}(u\omega) = 0
\end{equation}
We will thus operate the integration by parts on the $\doverd{(u\omega)}{r}$ term.
$r$ is here $\RPlanet + \text{altitude}$, thus $r$ is a spherical coordinate.

\subsubsection{In three dimensions}

$\dd V = \sin(\theta)r^2\dd\theta\dd\phi\dd r = \dd x \dd y \dd z$.
So here is the $v$ function, and what we need is an integration on
the atmosphere:
\begin{equation}
\intvol\left[\doverd{u}{t}v - \chi v - \doverd{(u\omega)}{r}v - \frac{2}{r}(u\omega)v\right] \dd V = 0
\end{equation}
with $V$ a volume element,
\begin{equation}
  \intvol\doverd{u}{t}v\dd V 
- \intvol\chi v \dd V 
- \intvol\doverd{(u\omega)}{r}v \dd V 
- \intvol\frac{2}{r}(u\omega)v \dd V = 0
\label{math:photo_3D_start}
\end{equation}
thus, developping $V$ in spherical coordinates:
\begin{equation}
\begin{split}
  \intr\doverd{u}{t}v\dVs
- \intr\chi v \dVs \\
- \intr\doverd{(u\omega)}{r}v \dVs
- \intr\frac{2}{r}(u\omega)v \dVs & = 0
\end{split}
\label{math:photo_3D_dev}
\end{equation}
Thus, integration by parts in the $r$ direction will give:
\begin{equation}
\begin{split}
  \intr\doverd{u}{t}v\dVs 
- \intr\chi v \dVs \\
+ \intr(u\omega)\left(\doverd{v}{r} + 2rv\right) \dVs
- \inttheta\intphy\left[u\omega v r^2\right]^{r_1}_{r_0}\sin(\theta)\dd\theta\dd\varphi \\
- \intr\frac{2}{r}(u\omega)v \dVs 
& = 0
\end{split}
\end{equation}
Which finally gives:
\begin{equation}
\begin{split}
  \intr\doverd{u}{t}v\dVs 
- \intr\chi v \dVs \\
+ \intr(u\omega)\doverd{v}{r}\dVs
- \inttheta\intphy\left[u\omega v r^2\right]^{r_1}_{r_0}\sin(\theta)\dd\theta\dd\varphi 
& = 0
\end{split}
\label{math:photo_3D_fin}
\end{equation}
Using the formulation:
\begin{equation}
u = \sum_{i=1}^N \ui_i \phi_i,\qquad v = \sum_{i=1}^N\vi_i \phi_i
\end{equation}
with $\ui \in \mathcal{R}$ and true $\forall \vi \in \mathcal{R}$. 
we rewrite Eq.~\ref{math:photo_3D_fin}
\begin{equation}
\begin{split}
  \intr\sum_{i=1}^N\ui_i\doverd{\phi_i}{t}\sum_{j=1}^N\vi_j \phi_j \dVs \\
- \intr\sum_{i=1}^N\chi\vi_i\phi_i \dVs \\
+ \intr\omega\sum_{i=1}^N\ui_i\phi_i\sum_{j=1}^N\vi_j\doverd{\phi_j}{r} \dVs \\
- \inttheta\intphy\left[u\omega v r^2\right]^{r_1}_{r_0}\sin(\theta)\dd\theta\dd\varphi & = 0
\end{split}
\end{equation}
with a little rearranging:
\begin{equation}
\begin{split}
  \underbrace{\sum_{i=1}^N\sum_{j=1}^N\ui_i\vi_j\intr\doverd{\phi_i}{t}\phi_j \dVs}_\text{ mass\_residual}                    \\
- \underbrace{\sum_{i=1}^N\vi_i\intr\chi\phi_i \dVs}_\text{ element\_time\_derivative}                                        \\
+ \underbrace{\sum_{i=1}^N\sum_{j=1}^N\ui_i\vi_j\intr\omega\phi_i\doverd{\phi_j}{r} \dVs}_\text{ element\_time\_derivative}   \\
- \underbrace{\inttheta\intphy\left[u\omega v r^2\right]^{r_1}_{r_0}\sin(\theta)\dd\theta\dd\varphi}_\text{ side\_time\_derivative}
& = 0
\end{split}
\end{equation}

\subsubsection{In one dimension}

We can make the assumption that the only interesting dimension is $r$, and
not caring for the other parameters ($\theta$ and $\varphi$). Either everything
is considered independant or we really solve only a 1D problem, still in spherical
coordinates, thus this is equivalent in integrating $\dd\theta\dd\varphi$ in Eq.~\ref{math:photo_3D_dev}, 
which would give a constant we can get rid of.
\begin{equation}
\int_{r_0}^{r_1}\left[   \doverd{u}{t} v 
                       - \chi v - \doverd{(u\omega)}{r} v
                       - \frac{2}{r}u\omega v
                \right] r^2 \dd r = 0
\end{equation}
now we integrate by parts:
\begin{equation}
\begin{split}
\int_{r_0}^{r_1}\doverd{(u\omega)}{r} v r^2 \dd r 
   & = - \int_{r_0}^{r_1}u\omega \left(\doverd{v}{r}r^2 + 2 r v\right) \dd r + \left[u\omega v r^2\right]_{r_0}^{r_1}
        \\[\baselineskip]
   & = - \int_{r_0}^{r_1}u\omega \doverd{v}{r} r^2  \dd r - 2 \int_{r_0}^{r_1}u\omega  r v \dd r  + \left[u\omega v r^2\right]_{r_0}^{r_1}
\end{split}
\end{equation}
So
\begin{equation}
\begin{split}
\int_{r_0}^{r_1} \left[   \doverd{u}{t} v r^2 \dd r
                        - \chi v
                        - \frac{2}{r} u\omega v
                        + u\omega\doverd{v}{r}
                        + \frac{2}{r} u\omega v
                 \right] r^2 \dd r 
     - \left[u\omega v r^2\right]_{r_0}^{r_1}   & = 0 \\
\int_{r_0}^{r_1} \left[   \doverd{u}{t} v r^2 \dd r
                        - \chi v
                        + u\omega\doverd{v}{r}
                 \right] r^2 \dd r 
     - \left[u\omega v r^2\right]_{r_0}^{r_1}   & = 0 
\end{split}
\end{equation}
using again the notations:
\begin{equation}
u = \sum_{i=0}^{N} \ui_i \phi_i, \qquad v = \sum_{i=0}^{N} \vi_i \phi_i
\end{equation}
We obtain:
\begin{equation}
 \int_{r_0}^{r_1}\left[
                  \sum_{i=0}^{N}\ui_i\doverd{\phi_i}{t} \sum_{j=0}^{N}\vi_j \phi_j
                 - \chi \sum_{i=0}^{N}\vi_i\phi_i 
                 + \sum_{i=0}^{N}\ui_i\phi_i\sum_{j=0}^{N}\vi_j\doverd{\phi_j}{r}\right]r^2\dd r
 - \left[u\omega v r^2\right]_{r_0}^{r_1} = 0
\end{equation}
The rearrangement gives:
\begin{equation}
\begin{split}
  \underbrace{\sum_{i=1}^{N}\sum_{j=0}^{N}\ui_i\vi_j\int_{r_0}^{r_1}\doverd{\phi_i}{t}\phi_jr^2\dd r}_\text{mass\_residual}      
- \underbrace{\sum_{i=0}^{N}\vi_i\int_{r_0}^{r_1}\chi\phi_i r^2\dd r}_\text{element\_time\_derivative}                           
+ \underbrace{\sum_{i=0}^{N}\sum_{j=0}^{N}\ui_i\vi_j\int_{r_0}^{r_1}\phi_i\doverd{\phi_j}{r}r^2\dd r}_\text{element\_time\_derivative}       \\
 - \underbrace{\left[u\omega v r^2\right]_{r_0}^{r_1}}_\text{side\_time\_derivative}  & = 0
\end{split}
\end{equation}


At this point, we link to \GRINS\footnote{\GitGrins}: the planetary code provides $\chi$, $u$ and
$\omega$ for any $s$ species and $r$ \GRINS\ asks. \LibMesh\footnote{\GitLibmesh} is the underlying library that
does all the calculations.
